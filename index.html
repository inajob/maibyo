<html>
<head>
<meta charset="UTF-8">
<style>
body {
  background-color: #669;
  color: white;
}
a{
  color:white;
}
h2{
color: #505050;
padding: 0.5em;
line-height: 1.3;
background: #dbebf8;
vertical-align: middle;
border-radius: 25px 0px 0px 25px;
}
h2:before {
content: '●';
color: #669;
margin-right: 8px;
}
.box{
  display: flex;
  flex-wrap: wrap;
}
.margin{
  margin:2em;
}
.tar{
  text-align:right;
}
#frequent img{
  width: 100px;
  height: 100px;
}
#img {
  width: 100px;
  height: 100px;
}
.piece{
  position: relative;
  float: left;
  margin:0.2em;
  border: solid 3px white;
}
.piece img{
  width: 160px;
  height: 160px;
}
.piece span{
  position: absolute;
  bottom:0px;
  right: 0px;
  background-color: blue;
  color: white;
}
</style>
</head>
<body>
<h1>Twitter Trend Image Stream</h1>
<h2>今話題の画像</h2>
<div id="images" class="margin box"></div>
<h2>最近の画像</h2>
<div id="frequent" class="margin">
<img id ="img" />
</div>
<h2>今日話題の画像</h2>
<div id="today" class="margin box"></div>
<hr>
<div class="tar">
つくったひと： <a href="http://twitter.com/ina_ani">@ina_ani</a><a href="https://twitter.com/ina_ani" class="twitter-follow-button" data-show-count="false">Follow @ina_ani</a><script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
</div>

<script>

var frequentImgElms = [];
var imgElms = [];
var aElms = [];
var elms = [];
var todayElms = [];
var imgIndex = 0;
var MAXFREQIMAGE = 24
var MAXIMAGE = 28

function createPiece(){
  var divElm = document.createElement("div");
  var elm = document.createElement("img");
  var aElm = document.createElement("a");
  var rtElm = document.createElement("span");

  divElm.className = "piece";
  rtElm.appendChild(document.createTextNode("0RT"));

  var ret = {
    a: aElm,
    img: elm,
    div: divElm,
    rt: rtElm,
  }
  aElm.target = "_blank";
  aElm.appendChild(elm);
  aElm.appendChild(rtElm);

  divElm.appendChild(aElm);
  return ret;
}

window.onload = function(){
  var frequentQueue = document.getElementById("frequent");
  for(var i = 0; i < MAXFREQIMAGE; i ++){
    var elm = document.createElement("img");
    elm.style.border="solid 3px white"
    frequentQueue.appendChild(elm);
    frequentImgElms[i] = elm;
  }

  // setup image element
  var images = document.getElementById("images");
  var todayImages = document.getElementById("today");
  for(var i = 0; i < MAXIMAGE; i ++){
    elms[i] = createPiece();
    images.appendChild(elms[i].div);

    todayElms[i] = createPiece();
    todayImages.appendChild(todayElms[i].div);
  }

  var connection = new WebSocket('ws://twitter-search.inajob.tk/ws');
  //var connection = new WebSocket('ws://localhost:8088/ws');
  // When the connection is open, send some data to the server
  connection.onopen = function () {
    connection.send('Ping'); // Send the message 'Ping' to the server
    setInterval(function(){
      connection.send('Ping');
    }, 10000)
  };
  

  // Log errors
  connection.onerror = function (error) {
    console.log('WebSocket Error ' + error);
  };

  function extractImage(t){
    console.log("extact image",t, t.image_urls)
    if(t.image_urls != null && t.image_urls.length > 0){
      console.log(t.image_urls[0])
      return t.image_urls[0]
    }
    return "";
  }

  // Log messages from the server
  connection.onmessage = function (e) {
    //console.log('Server: ' + e.data);
    var obj = JSON.parse(e.data);
    if(obj.type == "url"){
      obj.rank.url += ":thumb"
      
      if(obj.count <= 3){return} // check only one shot
      if(obj.retweet <= 3){return} // check only one shot
      var flag = false;
      frequentImgElms.forEach(function(e){
        if(e.src == obj.rank.url){
          flag = true;
        }
      })
      if(flag){return} // check already listed in queue
      
      var elm = document.getElementById("img");
      elm.src = obj.rank.url;
      
      //var img = document.createElement("img");
      //img.src = obj.rank.url;
      
      frequentImgElms[imgIndex].src = obj.rank.url;
      
      frequentImgElms.forEach(function(e, i){
        if(i != imgIndex){
          e.style.border = "solid 3px white";
        }else{
          e.style.border = "dotted 3px blue";
        }
      });
      
      imgIndex = (imgIndex + 1) % MAXFREQIMAGE;
    }else if(obj.type == "ranking"){
      var index = 0;
      obj.ranking.forEach(function(e, i){
        if(e.retweet <= 5){return;}
        if(index >= MAXIMAGE){return;}
        if(extractImage(e)==""){return;}
        elms[index].img.src = extractImage(e) + ':thumb'
        elms[index].a.href = e.twit
        elms[index].rt.innerHTML = e.retweet + "RT";
        index ++;
      });
      index = 0;
      obj.longRanking.forEach(function(e, i){
        if(e.retweet <= 5){return;}
        if(index >= MAXIMAGE){return;}
        if(extractImage(e)==""){return;}
        todayElms[index].img.src = extractImage(e) + ':thumb'
        todayElms[index].a.href = e.twit
        todayElms[index].rt.innerHTML = e.retweet + "RT";
        index ++;
      });
 
    }
  };

}
</script>

</body>
</html>
