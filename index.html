<html>
<head>
<style>
body {
  background-color: #669;
  color: white;
}
h2{
color: #505050;
padding: 0.5em;
line-height: 1.3;
background: #dbebf8;
vertical-align: middle;
border-radius: 25px 0px 0px 25px;
}
h2:before {
content: '●';
color: #669;
margin-right: 8px;
}
.margin{
  margin:2em;
}
#frequent img{
  width: 100px;
  height: 100px;
}
#img {
  width: 100px;
  height: 100px;
}
</style>
</head>
<body>
<h1>Twitter Trend Image Stream</h1>
<h2>今話題の画像</h2>
<div id="images" class="margin"></div>
<h2>今投稿された画像</h2>
<div class="margin">
<img id ="img" />
</div>
<h2>最近の画像</h2>
<div id="frequent" class="margin"></div>

<script>

var frequentImgElms = [];
var imgElms = [];
var aElms = [];
var imgIndex = 0;
var MAXFREQIMAGE = 24
var MAXIMAGE = 30

window.onload = function(){
  var frequentQueue = document.getElementById("frequent");
  for(var i = 0; i < MAXFREQIMAGE; i ++){
    var elm = document.createElement("img");
    elm.style.border="solid 3px white"
    frequentQueue.appendChild(elm);
    frequentImgElms[i] = elm;
  }

  // setup image element
  var images = document.getElementById("images");
  for(var i = 0; i < MAXIMAGE; i ++){
    var elm = document.createElement("img");
    var aElm = document.createElement("a");
    aElm.target = "_blank";
    aElm.appendChild(elm);
    images.appendChild(aElm);
    imgElms[i] = elm;
    aElms[i] = aElm;
  }

  var connection = new WebSocket('ws://localhost:5000/ws');
  // When the connection is open, send some data to the server
  connection.onopen = function () {
    connection.send('Ping'); // Send the message 'Ping' to the server
    setInterval(function(){
      connection.send('Ping');
    }, 10000)
  };
  

  // Log errors
  connection.onerror = function (error) {
    console.log('WebSocket Error ' + error);
  };

  // Log messages from the server
  connection.onmessage = function (e) {
    console.log('Server: ' + e.data);
    var obj = JSON.parse(e.data);
    if(obj.type == "url"){
      obj.url += ":thumb"
      
      if(obj.count <= 3){return} // check only one shot
      if(obj.retweet <= 5){return} // check only one shot
      var flag = false;
      frequentImgElms.forEach(function(e){
        if(e.src == obj.rank.url){
          flag = true;
        }
      })
      if(flag){return} // check already listed in queue
      
      var elm = document.getElementById("img");
      elm.src = obj.rank.url;
      
      //var img = document.createElement("img");
      //img.src = obj.rank.url;
      
      frequentImgElms[imgIndex].src = obj.rank.url;
      
      frequentImgElms.forEach(function(e, i){
        if(i != imgIndex){
          e.style.border = "solid 3px white";
        }else{
          e.style.border = "dotted 3px blue";
        }
      });
      
      imgIndex = (imgIndex + 1) % MAXFREQIMAGE;
    }else if(obj.type == "ranking"){
      var index = 0;
      obj.ranking.forEach(function(e, i){
        if(e.retweet <= 5){return;}
        if(index >= MAXIMAGE){return;}
        imgElms[i].src = e.url + ':thumb'
        aElms[i].href = e.twit
        index ++;
      });
    }
  };

}
</script>

</body>
</html>